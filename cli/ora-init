#!/bin/bash
# Ora Framework - Project Initialization CLI
# Creates complete project setup in under 5 minutes
#
# Usage: ora-init <project-name> [options]
#
# This script orchestrates:
#   - PostgreSQL schema creation
#   - Pinecone namespace creation
#   - Slack channel creation
#   - LangSmith project setup
#   - GitHub repository creation
#   - Agent deployment

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# Script directory
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
LIB_DIR="${SCRIPT_DIR}/lib"
PROJECTS_DIR="/Users/computer/projects"

# Source library functions
source "${LIB_DIR}/validate-project-name.sh"
source "${LIB_DIR}/progress-indicator.sh"
source "${LIB_DIR}/rollback-cleanup.sh"

# Configuration
PROJECT_NAME="${1:-}"
SKIP_INTERACTIVE="${SKIP_INTERACTIVE:-false}"
DRY_RUN="${DRY_RUN:-false}"

# Track what we've created for rollback
ROLLBACK_LOG="${SCRIPT_DIR}/.rollback-${PROJECT_NAME}.log"
rm -f "$ROLLBACK_LOG"

# ============================================================================
# USAGE & HELP
# ============================================================================

show_usage() {
    cat << EOF
${GREEN}Ora Framework - Project Initialization${NC}

${CYAN}Usage:${NC}
  ora-init <project-name> [options]

${CYAN}Arguments:${NC}
  project-name          Project name (lowercase, alphanumeric, hyphens only)

${CYAN}Options:${NC}
  --skip-interactive    Skip interactive prompts (use defaults)
  --dry-run             Show what would be done without executing
  --help                Show this help message

${CYAN}Examples:${NC}
  ora-init my-awesome-project
  ora-init test-project-alpha --skip-interactive
  ora-init demo-app --dry-run

${CYAN}What This Does:${NC}
  1. Creates PostgreSQL schema: ora_<project-name>
  2. Creates Pinecone namespace: <project-name>
  3. Creates Slack channel: #ora-<project-name>-agents
  4. Sets up LangSmith project: <project-name>
  5. Creates GitHub repository: <project-name>
  6. Deploys 3-5 standard agents
  7. Initializes project directory structure

${CYAN}Prerequisites:${NC}
  - PostgreSQL access (DB_HOST, DB_PORT, DB_NAME, DB_USER, DB_PASSWORD)
  - Pinecone API key (PINECONE_API_KEY)
  - Slack bot token (SLACK_BOT_TOKEN)
  - LangSmith API key (LANGSMITH_API_KEY)
  - GitHub personal access token (GITHUB_TOKEN)

${CYAN}Environment Variables:${NC}
  See README.md for complete list of required environment variables

EOF
}

# ============================================================================
# VALIDATION
# ============================================================================

validate_environment() {
    local missing_vars=()
    
    # Check required environment variables
    if [ -z "$DB_HOST" ] && [ -z "$POSTGRES_URI" ]; then
        missing_vars+=("DB_HOST or POSTGRES_URI")
    fi
    if [ -z "$PINECONE_API_KEY" ]; then
        missing_vars+=("PINECONE_API_KEY")
    fi
    if [ -z "$SLACK_BOT_TOKEN" ]; then
        missing_vars+=("SLACK_BOT_TOKEN")
    fi
    if [ -z "$LANGSMITH_API_KEY" ]; then
        missing_vars+=("LANGSMITH_API_KEY")
    fi
    if [ -z "$GITHUB_TOKEN" ]; then
        missing_vars+=("GITHUB_TOKEN")
    fi
    
    if [ ${#missing_vars[@]} -gt 0 ]; then
        echo -e "${RED}❌ Missing required environment variables:${NC}"
        for var in "${missing_vars[@]}"; do
            echo -e "  ${YELLOW}- ${var}${NC}"
        done
        echo ""
        echo "Set these variables before running ora-init"
        exit 1
    fi
    
    # Check required commands
    local missing_cmds=()
    command -v psql >/dev/null 2>&1 || missing_cmds+=("psql")
    command -v python3 >/dev/null 2>&1 || missing_cmds+=("python3")
    command -v node >/dev/null 2>&1 || missing_cmds+=("node")
    command -v gh >/dev/null 2>&1 || missing_cmds+=("gh (GitHub CLI)")
    
    if [ ${#missing_cmds[@]} -gt 0 ]; then
        echo -e "${RED}❌ Missing required commands:${NC}"
        for cmd in "${missing_cmds[@]}"; do
            echo -e "  ${YELLOW}- ${cmd}${NC}"
        done
        echo ""
        echo "Install missing tools before running ora-init"
        exit 1
    fi
}

# ============================================================================
# MAIN EXECUTION
# ============================================================================

main() {
    # Parse arguments
    if [ "$1" = "--help" ] || [ "$1" = "-h" ]; then
        show_usage
        exit 0
    fi
    
    if [ -z "$PROJECT_NAME" ]; then
        echo -e "${RED}❌ Error: Project name is required${NC}"
        echo ""
        show_usage
        exit 1
    fi
    
    # Check for options
    for arg in "$@"; do
        case "$arg" in
            --skip-interactive)
                SKIP_INTERACTIVE=true
                ;;
            --dry-run)
                DRY_RUN=true
                echo -e "${YELLOW}⚠️  DRY RUN MODE - No changes will be made${NC}"
                ;;
        esac
    done
    
    # Validate project name
    if ! validate_project_name "$PROJECT_NAME"; then
        echo -e "${RED}❌ Invalid project name: ${PROJECT_NAME}${NC}"
        echo ""
        echo "Project name must be:"
        echo "  - Lowercase only"
        echo "  - Alphanumeric and hyphens only"
        echo "  - Cannot start/end with hyphen"
        echo "  - Minimum 2 characters"
        echo ""
        echo "Example: my-awesome-project"
        exit 1
    fi
    
    # Validate environment (skip in dry-run mode)
    if [ "$DRY_RUN" = "false" ]; then
        validate_environment
    fi
    
    # Check if project already exists
    if [ -d "${PROJECTS_DIR}/${PROJECT_NAME}" ]; then
        echo -e "${YELLOW}⚠️  Project directory already exists: ${PROJECTS_DIR}/${PROJECT_NAME}${NC}"
        if [ "$SKIP_INTERACTIVE" = "false" ]; then
            read -p "Continue anyway? (y/N): " -n 1 -r
            echo
            if [[ ! $REPLY =~ ^[Yy]$ ]]; then
                echo "Aborted"
                exit 0
            fi
        fi
    fi
    
    # Start initialization
    echo ""
    echo -e "${GREEN}================================================================================"
    echo "  ORA FRAMEWORK - PROJECT INITIALIZATION"
    echo "================================================================================"
    echo -e "${NC}"
    echo -e "Project Name: ${CYAN}${PROJECT_NAME}${NC}"
    echo -e "Started:      ${CYAN}$(date '+%Y-%m-%d %H:%M:%S')${NC}"
    echo ""
    
    # Initialize rollback log
    echo "PROJECT_NAME=${PROJECT_NAME}" > "$ROLLBACK_LOG"
    echo "START_TIME=$(date +%s)" >> "$ROLLBACK_LOG"
    
    # Track start time
    START_TIME=$(date +%s)
    
    # Phase 1: Infrastructure Setup
    echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo -e "${BLUE}Phase 1: Infrastructure Setup${NC}"
    echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo ""
    
    # 1.1 PostgreSQL Schema
    echo -ne "${CYAN}[1]${NC} Creating PostgreSQL schema... ${YELLOW}(ora_${PROJECT_NAME})${NC}"
    echo ""
    if [ "$DRY_RUN" = "false" ]; then
        if "${SCRIPT_DIR}/../infrastructure/postgres/create-schema.sh" "$PROJECT_NAME"; then
            echo -e "  ${GREEN}✅ PostgreSQL schema created${NC}"
            echo "POSTGRES_SCHEMA=ora_${PROJECT_NAME}" >> "$ROLLBACK_LOG"
        else
            echo -e "  ${RED}❌ PostgreSQL schema creation failed${NC}"
            rollback_cleanup "$ROLLBACK_LOG"
            exit 1
        fi
    else
        echo "  [DRY RUN] Would create PostgreSQL schema: ora_${PROJECT_NAME}"
        echo -e "  ${GREEN}✅ PostgreSQL schema (dry run)${NC}"
    fi
    
    # 1.2 Pinecone Namespace
    echo -ne "${CYAN}[2]${NC} Creating Pinecone namespace... ${YELLOW}(${PROJECT_NAME})${NC}"
    echo ""
    if [ "$DRY_RUN" = "false" ]; then
        if python3 "${SCRIPT_DIR}/../infrastructure/pinecone/create-namespace.py" "$PROJECT_NAME"; then
            echo -e "  ${GREEN}✅ Pinecone namespace created${NC}"
            echo "PINECONE_NAMESPACE=${PROJECT_NAME}" >> "$ROLLBACK_LOG"
        else
            echo -e "  ${RED}❌ Pinecone namespace creation failed${NC}"
            rollback_cleanup "$ROLLBACK_LOG"
            exit 1
        fi
    else
        echo "  [DRY RUN] Would create Pinecone namespace: ${PROJECT_NAME}"
        echo -e "  ${GREEN}✅ Pinecone namespace (dry run)${NC}"
    fi
    
    # 1.3 Slack Channel
    echo -ne "${CYAN}[3]${NC} Creating Slack channel... ${YELLOW}(ora-${PROJECT_NAME}-agents)${NC}"
    echo ""
    if [ "$DRY_RUN" = "false" ]; then
        if node "${SCRIPT_DIR}/../infrastructure/slack/create-channel.js" "$PROJECT_NAME"; then
            echo -e "  ${GREEN}✅ Slack channel created${NC}"
            echo "SLACK_CHANNEL=ora-${PROJECT_NAME}-agents" >> "$ROLLBACK_LOG"
        else
            echo -e "  ${RED}❌ Slack channel creation failed${NC}"
            rollback_cleanup "$ROLLBACK_LOG"
            exit 1
        fi
    else
        echo "  [DRY RUN] Would create Slack channel: #ora-${PROJECT_NAME}-agents"
        echo -e "  ${GREEN}✅ Slack channel (dry run)${NC}"
    fi
    
    # 1.4 LangSmith Project
    echo -ne "${CYAN}[4]${NC} Setting up LangSmith project... ${YELLOW}(${PROJECT_NAME})${NC}"
    echo ""
    if [ "$DRY_RUN" = "false" ]; then
        # LangSmith setup is manual for now (see infrastructure/langsmith/setup-project.md)
        echo -e "${YELLOW}⚠️  LangSmith project setup requires manual configuration${NC}"
        echo "  See: ${SCRIPT_DIR}/../infrastructure/langsmith/setup-project.md"
        echo "  Project name: ${PROJECT_NAME}"
        echo -e "  ${GREEN}✅ LangSmith project (manual setup required)${NC}"
    else
        echo "  [DRY RUN] Would set up LangSmith project: ${PROJECT_NAME}"
        echo -e "  ${GREEN}✅ LangSmith project (dry run)${NC}"
    fi
    
    # 1.5 GitHub Repository
    echo -ne "${CYAN}[5]${NC} Creating GitHub repository... ${YELLOW}(${PROJECT_NAME})${NC}"
    echo ""
    if [ "$DRY_RUN" = "false" ]; then
        if gh repo create "$PROJECT_NAME" \
            --description "Ora Framework - ${PROJECT_NAME} autonomous agent system" \
            --private \
            --clone 2>/dev/null; then
            echo -e "  ${GREEN}✅ GitHub repository created${NC}"
            echo "GITHUB_REPO=${PROJECT_NAME}" >> "$ROLLBACK_LOG"
        else
            # Repository might already exist
            echo -e "${YELLOW}⚠️  GitHub repository creation skipped (may already exist)${NC}"
            echo -e "  ${GREEN}✅ GitHub repository (skipped)${NC}"
        fi
    else
        echo "  [DRY RUN] Would create GitHub repository: ${PROJECT_NAME}"
        echo -e "  ${GREEN}✅ GitHub repository (dry run)${NC}"
    fi
    
    echo ""
    
    # Phase 2: Project Structure
    echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo -e "${BLUE}Phase 2: Project Structure${NC}"
    echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo ""
    
    PROJECT_DIR="${PROJECTS_DIR}/${PROJECT_NAME}"
    
    echo -ne "${CYAN}[6]${NC} Creating project directory... ${YELLOW}(${PROJECT_DIR})${NC}"
    echo ""
    if [ "$DRY_RUN" = "false" ]; then
        mkdir -p "$PROJECT_DIR"
        echo "PROJECT_DIR=${PROJECT_DIR}" >> "$ROLLBACK_LOG"
        echo -e "  ${GREEN}✅ Project directory created${NC}"
    else
        echo "  [DRY RUN] Would create directory: ${PROJECT_DIR}"
        echo -e "  ${GREEN}✅ Project directory (dry run)${NC}"
    fi
    
    # Initialize Git if not already done
    if [ "$DRY_RUN" = "false" ] && [ ! -d "${PROJECT_DIR}/.git" ]; then
        echo -ne "${CYAN}[7]${NC} Initializing Git repository..."
        echo ""
        cd "$PROJECT_DIR"
        git init >/dev/null 2>&1
        echo -e "  ${GREEN}✅ Git repository initialized${NC}"
    fi
    
    # Create project structure
    echo -ne "${CYAN}[8]${NC} Creating project structure..."
    echo ""
    if [ "$DRY_RUN" = "false" ]; then
        mkdir -p "${PROJECT_DIR}/agents/_queue/inbox"
        mkdir -p "${PROJECT_DIR}/agents/_queue/outbox"
        mkdir -p "${PROJECT_DIR}/agents/_queue/processed"
        mkdir -p "${PROJECT_DIR}/infrastructure"
        mkdir -p "${PROJECT_DIR}/core"
        mkdir -p "${PROJECT_DIR}/docs"
        mkdir -p "${PROJECT_DIR}/scripts"
        echo -e "  ${GREEN}✅ Project structure created${NC}"
    else
        echo "  [DRY RUN] Would create project structure"
        echo -e "  ${GREEN}✅ Project structure (dry run)${NC}"
    fi
    
    # Create README.md
    echo -ne "${CYAN}[9]${NC} Creating project README..."
    echo ""
    if [ "$DRY_RUN" = "false" ]; then
        cat > "${PROJECT_DIR}/README.md" << EOF
# ${PROJECT_NAME}

Ora Framework - Autonomous Agent System

## Project Details

- **Project Name**: ${PROJECT_NAME}
- **PostgreSQL Schema**: ora_${PROJECT_NAME}
- **Pinecone Namespace**: ${PROJECT_NAME}
- **Slack Channel**: #ora-${PROJECT_NAME}-agents
- **LangSmith Project**: ${PROJECT_NAME}
- **GitHub Repository**: ${PROJECT_NAME}

## Created

$(date '+%Y-%m-%d %H:%M:%S')

## Next Steps

1. Configure environment variables
2. Deploy agents
3. Start autonomous director sessions

EOF
        echo -e "  ${GREEN}✅ README.md created${NC}"
    else
        echo "  [DRY RUN] Would create README.md"
        echo -e "  ${GREEN}✅ README.md (dry run)${NC}"
    fi
    
    echo ""
    
    # Phase 3: Agent Deployment
    echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo -e "${BLUE}Phase 3: Agent Deployment${NC}"
    echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo ""
    
    # Deploy standard agents
    AGENT_ARCHETYPES=("research-agent" "implementation-agent" "qa-agent" "documentation-agent" "infrastructure-agent")
    STEP=10
    
    for archetype in "${AGENT_ARCHETYPES[@]}"; do
        echo -ne "${CYAN}[${STEP}]${NC} Deploying ${archetype}..."
        echo ""
        if [ "$DRY_RUN" = "false" ]; then
            # Copy agent template and customize
            TEMPLATE_FILE="${SCRIPT_DIR}/../agent-templates/archetypes/${archetype}.json"
            if [ -f "$TEMPLATE_FILE" ]; then
                # For now, just copy template - full customization would require template engine
                mkdir -p "${PROJECT_DIR}/agents/${archetype}"
                cp "$TEMPLATE_FILE" "${PROJECT_DIR}/agents/${archetype}/template.json"
                echo -e "  ${GREEN}✅ ${archetype} deployed${NC}"
            else
                echo -e "${YELLOW}⚠️  Template not found: ${TEMPLATE_FILE}${NC}"
                echo -e "  ${GREEN}✅ ${archetype} (template not found)${NC}"
            fi
        else
            echo "  [DRY RUN] Would deploy ${archetype}"
            echo -e "  ${GREEN}✅ ${archetype} (dry run)${NC}"
        fi
        STEP=$((STEP + 1))
    done
    
    echo ""
    
    # Calculate elapsed time
    END_TIME=$(date +%s)
    ELAPSED=$((END_TIME - START_TIME))
    MINUTES=$((ELAPSED / 60))
    SECONDS=$((ELAPSED % 60))
    
    # Success summary
    echo -e "${GREEN}================================================================================"
    echo "  ✅ PROJECT INITIALIZATION COMPLETE"
    echo "================================================================================"
    echo -e "${NC}"
    echo -e "Project Name: ${CYAN}${PROJECT_NAME}${NC}"
    echo -e "Time Elapsed: ${CYAN}${MINUTES}m ${SECONDS}s${NC}"
    echo ""
    echo "Project Location:"
    echo "  ${PROJECT_DIR}"
    echo ""
    echo "Next Steps:"
    echo "  1. cd ${PROJECT_DIR}"
    echo "  2. Configure environment variables (.env file)"
    echo "  3. Review agent templates in agents/"
    echo "  4. Start autonomous director sessions"
    echo ""
    echo "Check status:"
    echo "  ora-status ${PROJECT_NAME}"
    echo ""
    
    # Clean up rollback log on success
    rm -f "$ROLLBACK_LOG"
    
    exit 0
}

# Run main function
main "$@"

