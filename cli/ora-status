#!/bin/bash
# Ora Framework - Project Status CLI
# Shows status of an Ora project
#
# Usage: ora-status <project-name>

set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

PROJECT_NAME="${1:-}"
PROJECTS_DIR="/Users/computer/projects"

show_usage() {
    cat << EOF
${GREEN}Ora Framework - Project Status${NC}

${CYAN}Usage:${NC}
  ora-status <project-name>

${CYAN}Examples:${NC}
  ora-status my-awesome-project
  ora-status test-project-alpha

EOF
}

check_postgres_schema() {
    local schema_name="ora_${PROJECT_NAME}"
    local exists=$(psql -h "${DB_HOST:-localhost}" -p "${DB_PORT:-5432}" -U "${DB_USER:-postgres}" -d "${DB_NAME:-postgres}" -tAc \
        "SELECT EXISTS(SELECT 1 FROM information_schema.schemata WHERE schema_name = '${schema_name}');" 2>/dev/null || echo "false")
    
    if [ "$exists" = "t" ]; then
        echo -e "  ${GREEN}✅ PostgreSQL schema exists: ${schema_name}${NC}"
        return 0
    else
        echo -e "  ${RED}❌ PostgreSQL schema not found: ${schema_name}${NC}"
        return 1
    fi
}

check_pinecone_namespace() {
    local namespace="$PROJECT_NAME"
    
    if command -v python3 >/dev/null 2>&1 && [ -n "$PINECONE_API_KEY" ]; then
        python3 << EOF
import os
import sys
from pinecone import Pinecone

try:
    pc = Pinecone(api_key=os.getenv('PINECONE_API_KEY'))
    index_name = os.getenv('PINECONE_INDEX_NAME', 'ora-framework-index')
    index = pc.Index(index_name)
    stats = index.describe_index_stats()
    
    if '${namespace}' in stats.get('namespaces', {}):
        print("  ✅ Pinecone namespace exists: ${namespace}")
        sys.exit(0)
    else:
        print("  ❌ Pinecone namespace not found: ${namespace}")
        sys.exit(1)
except Exception as e:
    print(f"  ⚠️  Could not check Pinecone namespace: {e}")
    sys.exit(2)
EOF
        return $?
    else
        echo -e "  ${YELLOW}⚠️  Cannot check Pinecone (python3 or PINECONE_API_KEY not available)${NC}"
        return 2
    fi
}

check_slack_channel() {
    local channel_name="ora-${PROJECT_NAME}-agents"
    
    if command -v node >/dev/null 2>&1 && [ -n "$SLACK_BOT_TOKEN" ]; then
        node << EOF
const { WebClient } = require('@slack/web-api');
const client = new WebClient(process.env.SLACK_BOT_TOKEN);

client.conversations.list({ types: 'public_channel,private_channel', exclude_archived: true })
  .then(result => {
    const exists = result.channels.some(ch => ch.name === '${channel_name}');
    if (exists) {
      console.log('  ✅ Slack channel exists: #${channel_name}');
      process.exit(0);
    } else {
      console.log('  ❌ Slack channel not found: #${channel_name}');
      process.exit(1);
    }
  })
  .catch(err => {
    console.log(\`  ⚠️  Could not check Slack channel: \${err.message}\`);
    process.exit(2);
  });
EOF
        return $?
    else
        echo -e "  ${YELLOW}⚠️  Cannot check Slack (node or SLACK_BOT_TOKEN not available)${NC}"
        return 2
    fi
}

check_project_directory() {
    local project_dir="${PROJECTS_DIR}/${PROJECT_NAME}"
    
    if [ -d "$project_dir" ]; then
        echo -e "  ${GREEN}✅ Project directory exists: ${project_dir}${NC}"
        
        # Check for key directories
        if [ -d "${project_dir}/agents" ]; then
            echo -e "    ${GREEN}✓ agents/ directory${NC}"
        else
            echo -e "    ${YELLOW}⚠ agents/ directory missing${NC}"
        fi
        
        if [ -d "${project_dir}/.git" ]; then
            echo -e "    ${GREEN}✓ Git repository initialized${NC}"
        else
            echo -e "    ${YELLOW}⚠ Git repository not initialized${NC}"
        fi
        
        return 0
    else
        echo -e "  ${RED}❌ Project directory not found: ${project_dir}${NC}"
        return 1
    fi
}

main() {
    if [ -z "$PROJECT_NAME" ]; then
        echo -e "${RED}❌ Error: Project name is required${NC}"
        echo ""
        show_usage
        exit 1
    fi
    
    echo ""
    echo -e "${GREEN}${'='*80}"
    echo "  ORA FRAMEWORK - PROJECT STATUS"
    echo "================================================================================"
    echo -e "${NC}"
    echo -e "Project Name: ${CYAN}${PROJECT_NAME}${NC}"
    echo -e "Checked:      ${CYAN}$(date '+%Y-%m-%d %H:%M:%S')${NC}"
    echo ""
    
    echo -e "${BLUE}Infrastructure Status:${NC}"
    check_postgres_schema
    check_pinecone_namespace
    check_slack_channel
    echo ""
    
    echo -e "${BLUE}Project Structure:${NC}"
    check_project_directory
    echo ""
    
    echo -e "${GREEN}${'='*80}${NC}"
    echo ""
}

main "$@"

